<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://coveralls.io/github/nestjs/nest?branch=master" target="_blank"><img src="https://coveralls.io/repos/github/nestjs/nest/badge.svg?branch=master#9" alt="Coverage" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

This repository contains the code for the checkit API written with the nestjs framework. The project includes 3 main modules which are the auth, order and chat.

For user's to have access to the order and chat routes they have to be authenticated. Even the websocket connection and events are all auth required. Hence a Bearer token is required for all routes.

The documentation for all endpoints is written with swagger and can be found at /api/docs of the root domain. I.e if the project is running on http://localhost:3000, then the docs is found here: http://localhost:3000/api/docs. 

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# e2e tests
$ npm run test:e2e
```

## Testing E2E

Although not elegant, the way the integrated test works is that a dedicated test database is created. This is done by directly changing the DATABASE_URL to a test db inside .env file generated by prisma. Yes, there are issues with this process, but I resorted to doing it this way because for some reason prisma kept loading the .env file rather than the .env.test.local file I specified.
A better test process would be worked on but for now this is how the E2E testing works.
So directly change the DATABASE_URL inside .env to point to a test database.

## Logs
A persistent logger was also created which logs error and certain requests to a log file found in logs/app.log on the root level of the project.

## Chat system
For the chat system, websocket is used and in particular socket.io. It runs on the same root domain url as the http server itself. That is, if your server is running on http://localhost:3000, then this is also the url you make the websocket connection to on the frontend. The websocket request should also include a Bearer token like normal http requests. There are 3 main events for this chat system

* join-room
* send-message
* receive-message

A customer can only join rooms associated with the order they have created while admins can join any room. To join a room, the following payload is required in the websocket message and is sent to the **join-room** event.

```json
{
  "order_id": 4
}
```
> üìù **Note:** For a customer, the order_id can only be the id for an order they created.

To send message to a room, the following payload is required in the websocket message and is sent to the **send-message** event.

```json
{
  "order_id": 4,
  "message": "Please where do I make the payment"
}
```

To receive a message from any room, the client must be listening on the **receive-message** event.

The websocket requests does not persist the chat messages. Typically, for persistence, a http request is also made alongside the websocket request (could be immediately after the websocket request or before) on the client side. To persist a chat or fetch all the chats associated with an order, the chat endpoints found in the swagger docs is used.

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).
